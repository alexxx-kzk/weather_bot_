import os
import telebot
import requests
import json
from flask import Flask
import threading

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
BOT_TOKEN = os.environ['BOT_TOKEN']  # –¢–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ Secrets!
WEATHER_API_KEY = "d471f3fdf6e8a43384a37b71fe16102b"

bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

def get_weather(city_name):
    """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–≥–æ–¥—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞"""
    try:
        url = f"http://api.openweathermap.org/data/2.5/weather?q={city_name}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
        response = requests.get(url)
        data = response.json()

        if data["cod"] != 200:
            return None

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ
        city = data["name"]
        country = data["sys"]["country"]
        temp = round(data["main"]["temp"])
        feels_like = round(data["main"]["feels_like"])
        humidity = data["main"]["humidity"]
        pressure = data["main"]["pressure"]
        wind_speed = data["wind"]["speed"]
        description = data["weather"][0]["description"].capitalize()
        weather_icon = data["weather"][0]["main"]

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∫–æ–Ω–∫–∏ –ø–æ–≥–æ–¥—ã –≤ —ç–º–æ–¥–∑–∏
        icon_map = {
            "Clear": "‚òÄÔ∏è",
            "Clouds": "‚òÅÔ∏è",
            "Rain": "üåßÔ∏è",
            "Drizzle": "üå¶Ô∏è",
            "Thunderstorm": "‚õàÔ∏è",
            "Snow": "‚ùÑÔ∏è",
            "Mist": "üå´Ô∏è",
            "Fog": "üå´Ô∏è"
        }

        emoji = icon_map.get(weather_icon, "üå§Ô∏è")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        weather_info = (
            f"{emoji} –ü–æ–≥–æ–¥–∞ –≤ {city}, {country}:\n\n"
            f"‚Ä¢ {description}\n"
            f"‚Ä¢ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C\n"
            f"‚Ä¢ –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: {feels_like}¬∞C\n"
            f"‚Ä¢ –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%\n"
            f"‚Ä¢ –î–∞–≤–ª–µ–Ω–∏–µ: {pressure} –≥–ü–∞\n"
            f"‚Ä¢ –í–µ—Ç–µ—Ä: {wind_speed} –º/—Å"
        )

        return weather_info

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã: {e}")
        return None

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message,
                 "üå§Ô∏è –ü—Ä–∏–≤–µ—Ç! –Ø –º–æ–≥—É —Ç–µ–±–µ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –ø–æ–≥–æ–¥–∞ –≤ —Ç–≤–æ–µ–º –≥–æ—Ä–æ–¥–µ!\n\n"
                 "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏ —è –ø–æ–∫–∞–∂—É —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É.\n\n"
                 "–ü—Ä–∏–º–µ—Ä—ã:\n"
                 "‚Ä¢ –ú–æ—Å–∫–≤–∞\n"
                 "‚Ä¢ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥\n"
                 "‚Ä¢ –ö–∞–∑–∞–Ω—å\n"
                 "‚Ä¢ –í–ª–∞–¥–∏–º–∏—Ä\n\n"
                 "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /weather")

@bot.message_handler(commands=['help'])
def send_help(message):
    bot.reply_to(message,
                 "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:\n\n"
                 "1. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞\n"
                 "2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /weather\n\n"
                 "–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:\n"
                 "‚Ä¢ –ú–æ—Å–∫–≤–∞\n"
                 "‚Ä¢ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥\n"
                 "‚Ä¢ –ö–∞–∑–∞–Ω—å\n"
                 "‚Ä¢ –í–ª–∞–¥–∏–º–∏—Ä\n\n"
                 "–ë–æ—Ç –ø–æ–∫–∞–∂–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ø–æ–≥–æ–¥—É!")

@bot.message_handler(commands=['weather'])
def ask_city(message):
    msg = bot.reply_to(message, "üåç –í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É?")
    bot.register_next_step_handler(msg, process_city)

@bot.message_handler(content_types=['text'])
def handle_text(message):
    user_text = message.text.strip()

    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if user_text.startswith('/'):
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
    process_city(message)

def process_city(message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–≥–æ–¥—ã –ø–æ –≥–æ—Ä–æ–¥—É"""
    try:
        city_name = message.text.strip()

        if not city_name:
            bot.reply_to(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.")
            return

        bot.send_chat_action(message.chat.id, 'typing')

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
        weather_info = get_weather(city_name)

        if weather_info:
            bot.reply_to(message, weather_info)
        else:
            bot.reply_to(message,
                         f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–≥–æ–¥—É –¥–ª—è –≥–æ—Ä–æ–¥–∞ '{city_name}'.\n"
                         f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                         "‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è\n"
                         "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ\n"
                         "‚Ä¢ –ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É: '–ú–æ—Å–∫–≤–∞, RU'")

    except Exception as e:
        bot.reply_to(message, "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# Web-—Å–µ—Ä–≤–µ—Ä –¥–ª—è UptimeRobot
@app.route('/')
def home():
    return "‚úÖ –ü–æ–≥–æ–¥–Ω—ã–π –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω!"

@app.route('/ping')
def ping():
    return "pong"

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
def run_bot():
    print("üü¢ –ü–æ–≥–æ–¥–Ω—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
    bot_thread = threading.Thread(target=run_bot, daemon=True)
    bot_thread.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º web-—Å–µ—Ä–≤–µ—Ä
    print("üöÄ Web-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    app.run(host='0.0.0.0', port=5000)
